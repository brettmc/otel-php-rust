# Contributing

## Development

Using docker + compose, `Dockerfile` provides PHP 7.0-8.4 + rust environment to build and
test in. I've added `Makefile`s to make things easier, and written some tests using PHP's
[phpt](https://qa.php.net/phpt_details.php).

Quick-start:

* `git clone <this repo>`
* `cp .env.dist .env`
* modify `.env` to set the PHP version you want to work on
* `make build-image`
* `docker compose up -d collector` (if you want to run the `otlp` tests)
* `make bash` to shell into the container

From this bash shell, there is another Makefile to build the extension and run the tests.
Tests are organised as:

- `make clean` - clean up. Make sure you do this when switching PHP versions.
- `make test` - basic phpt tests
- `make test-auto` - auto-instrumentation
- `make test-export` - otlp (`http/protobuf` + `grpc`) exporting to a local collector
- `make test-http` - spin up a cli-server and test auto-creation of root spans
- `make test-all` - all tests

### PHP 7.x

(tested back to 7.0)

Note that a couple of tests are skipped because they check for logs written during RSHUTDOWN/MSHUTDOWN, which doesn't work in PHP 7.x.

## Building and running the tests

* `make check` - runs `cargo check` to ensure the code compiles without building
* `make build` - builds the extension for release (smaller, but not stripped)
* `make build-test` - builds the extension for testing (larger, but with debug symbols)
* `make install` - build a release, copy it to the PHP extensions directory

## Switching PHP versions

When switching between PHP versions, make sure you `make clean` between. In particular,
`php_bindings.rs` is generated by phper and is version-specific, so it needs to be regenerated
for each PHP version you work on.

## Debugging

### Logging

The most useful tool for debugging during development has been dialing up the logs: `otel.log.level=debug` (or `trace`,
which gives you a lot of info about what opentelemetry-rust is up to).

### Low-level debugging

I've had a couple of interesting panics and deadlocks whilst developing the extension. They've mostly been related to
contention over shared resources between multiple apache workers. Usually, rust will `panic` which provides some good
guidance. At least once, I've encountered a deadlock in apache+cli-server, which was more difficult to track down.
I eventually found the cause by running the cli-server through `gdb` and eventually catching an interesting backtrace.

#### gdb

The included `Dockerfile` contains `gdb` and PHP debug symbols, so you can run something like this:

`gdb --args php -d extension=otel -d otel.log.level=debug -S 0.0.0.0:8081 -t /usr/src/myapp/demo/zf1/public`

Then, `run` as usual until the _bad thing_ happens, and type `bt` to get a backtrace. Good luck!
